/*!
 * yyl-ssr-logger cjs 0.1.0
 * (c) 2020 - 2020 jackness
 * Released under the MIT License.
 */
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,r=e(require("path")),i=e(require("fs")),o=e(require("dayjs")),n=e(require("chalk"));function s(e){const t=e.replace(/[/\\]$/,""),o=[];return function e(t){i.existsSync(t)||/[/\\]$/.test(t)||(e(r.dirname(t)),i.mkdirSync(t),o.push(t))}(t),o}(t=exports.LogType||(exports.LogType={})).Info="info",t.Warn="warn",t.Error="error",t.Success="success",t.System="system",exports.Log=class{constructor(e){this.logCache=[],this.intervalKey=0,this.runtimeLogPath="",this.errorLogPath="",this.logPath=r.join(process.cwd(),"./log"),this.runtimeLimitSize=2048e3,this.writeInterval=1e3,this.verbose=!1,this.runtimeFilename="runtime.log",this.errorFilename="error.log",this.logSep="\n",this.formatter=e=>{const t=Object.assign({},e);return delete t.args,JSON.stringify(t)},this.logger=(e,t)=>{console.log(`${n.green("[ssr]")} - ${n[e===exports.LogType.Error?"red":"gray"](`[${e}]`)}`,...t)},(null==e?void 0:e.logPath)&&(this.logPath=e.logPath),void 0!==(null==e?void 0:e.runtimeLimitSize)&&(this.runtimeLimitSize=e.runtimeLimitSize),(null==e?void 0:e.writeInterval)&&(this.writeInterval=e.writeInterval),(null==e?void 0:e.verbose)&&(this.verbose=e.verbose),(null==e?void 0:e.runtimeFilename)&&(this.runtimeFilename=e.runtimeFilename),(null==e?void 0:e.errorFilename)&&(this.errorFilename=e.errorFilename),(null==e?void 0:e.formatter)&&(this.formatter=e.formatter),(null==e?void 0:e.logger)&&(this.logger=e.logger);const t=r.resolve(this.logPath,this.runtimeFilename);s(r.dirname(t)),i.writeFileSync(t,""),this.runtimeLogPath=t;const o=r.resolve(this.logPath,this.errorFilename);s(r.dirname(o)),i.writeFileSync(o,""),this.errorLogPath=o,this.intervalKey=setInterval(()=>{this.writer()},this.writeInterval)}log(e){var t;const{logCache:r,verbose:i,logger:n}=this,s=Object.assign(Object.assign({},e),{type:e.type||exports.LogType.Info,path:e.path||"system",content:(null===(t=e.args)||void 0===t?void 0:t.map(e=>"object"==typeof e?"string"==typeof e.stack?e.stack:JSON.stringify(e):e))||"",date:o().format("YYYY-MM-DD hh:mm:ss")});r.push(s),i&&n(s.type,s.args)}writer(){const{logCache:e,runtimeLimitSize:t,runtimeLogPath:r,errorLogPath:o,formatter:s,logSep:l,verbose:a,logger:h}=this;if(!e.length)return;const g=e.map(e=>s(e)),c=e.filter(e=>e.type===exports.LogType.Error).map(e=>s(e));if(g.length)if(t>0)if(i.statSync(r).size>t){const e=i.readFileSync(r).toString().split(l);i.writeFileSync(r,`${e.join(l)}${l}${g.join(l)}${l}`)}else i.appendFileSync(r,`${g.join(l)}${l}`);else i.appendFileSync(r,`${g.join(l)}${l}`);c.length&&i.appendFileSync(o,`${c.join(l)}${l}`),a&&h(exports.LogType.System,["写入日志文件完成","runtime: "+n.green(g.length),"error: "+n.red(c.length)]),e.length=0}clear(){this.logCache=[],clearInterval(this.intervalKey)}};
